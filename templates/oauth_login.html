<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login con Google - Biblioteca UTH</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.2);
      max-width: 600px;
      width: 100%;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
    }

    .loading {
      text-align: center;
      color: #666;
      font-size: 1.2em;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .result {
      margin-top: 30px;
      padding: 20px;
      border-radius: 8px;
      display: none;
    }

    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .user-info {
      background: #f0f4ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .token-display {
      background: #2d2d2d;
      color: #4ec9b0;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .btn {
      display: inline-block;
      padding: 10px 20px;
      margin-top: 15px;
      background: #667eea;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      background: #5568d3;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîê Login con Google</h1>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Procesando autenticaci√≥n...</p>
    </div>

    <div id="result" class="result"></div>
  </div>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);

      // 1) Si hay error en query, mostrarlo
      const error = params.get("error");
      if (error) {
        showError("Login cancelado o error: " + error);
        return;
      }

      // 2) Si vienen tokens desde el callback, guardarlos y mostrar √©xito
      const access = params.get("access_token");
      const refresh = params.get("refresh_token");
      const userInfoRaw = params.get("user_info");
      const googleInfoRaw = params.get("google_info");
      const message = params.get("message") || "Login exitoso con Google";

      if (access) {
        localStorage.setItem("access_token", access);
        if (refresh) localStorage.setItem("refresh_token", refresh);

        // Opcional: guardar info
        if (userInfoRaw) localStorage.setItem("user_info", userInfoRaw);
        if (googleInfoRaw) localStorage.setItem("google_info", googleInfoRaw);

        // Parsear info para mostrar bonito (si viene)
        let user = null;
        let google = null;
        try { user = userInfoRaw ? JSON.parse(userInfoRaw) : null; } catch (e) {}
        try { google = googleInfoRaw ? JSON.parse(googleInfoRaw) : null; } catch (e) {}

        showSuccess({
          message,
          access,
          refresh,
          user,
          google
        });

        // 3) Limpia la URL para evitar loops al recargar
        window.history.replaceState({}, document.title, "/oauth/login/");
        return;
      }

      // 4) Si NO vienen tokens pero ya hay token guardado, muestra que ya est√° logueado
      const savedAccess = localStorage.getItem("access_token");
      if (savedAccess) {
        showSuccess({
          message: "Ya tienes sesi√≥n iniciada ‚úÖ",
          access: savedAccess,
          refresh: localStorage.getItem("refresh_token"),
          user: null,
          google: null
        });
        return;
      }

      // 5) Si no hay nada, inicia login con Google
      window.location.href = "/api/auth/google/redirect/";

      function showSuccess(data) {
        document.getElementById('loading').style.display = 'none';
        const resultDiv = document.getElementById('result');
        resultDiv.className = 'result success';
        resultDiv.style.display = 'block';

        const userHtml = data.user ? `
          <div class="user-info">
            <h3>üë§ Datos del Usuario</h3>
            <p><strong>Email:</strong> ${data.user.email || ""}</p>
            <p><strong>Nombre:</strong> ${(data.user.first_name || "")} ${(data.user.last_name || "")}</p>
            <p><strong>Username:</strong> ${data.user.username || ""}</p>
          </div>
        ` : "";

        const picHtml = (data.google && data.google.picture) ? `
          <div style="margin-top:10px">
            <img src="${data.google.picture}" alt="Foto de perfil" style="border-radius:50%;width:96px;height:96px">
          </div>
        ` : "";

        resultDiv.innerHTML = `
          <h2>‚úÖ ${data.message}</h2>
          ${userHtml}
          ${picHtml}
          <div class="token-display">
            <strong>üîë Access Token (JWT):</strong><br>
            ${data.access ? data.access.substring(0, 50) + "..." : "N/A"}
          </div>
          <a href="/api/" class="btn">üìö Ir a la API</a>
          <a href="/" class="btn">üè† Volver al Inicio</a>
        `;
      }

      function showError(errorMessage) {
        document.getElementById('loading').style.display = 'none';
        const resultDiv = document.getElementById('result');
        resultDiv.className = 'result error';
        resultDiv.style.display = 'block';

        resultDiv.innerHTML = `
          <h2>‚ùå Error en el Login</h2>
          <p>${errorMessage}</p>
          <a href="/oauth/login/" class="btn">üîÅ Reintentar</a>
          <a href="/" class="btn">üè† Volver al Inicio</a>
        `;
      }
    })();
  </script>
</body>

</html>